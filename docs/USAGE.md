
# CSV Export & Restore Format

This section documents the precise format of the CSV file generated by the CFA Master Clerk Entry Tool, and how it can be used to restore the full show state. This is the authoritative reference for both export and import/restore logic.

---

## CSV Export & Restore Format (Updated)

### Section Separation
- **A blank row is inserted before the beginning of each new section** (including before General Information, Championship, Premiership, Kitten, Household Pet).
- Each section starts with a section label row in the first column (e.g., "General Information", "Championship Awards").

### Tabular Sections (Championship, Premiership, Kitten, Household Pet)
- Each tabular section is exported as a table:
  - Three header rows: Ring Numbers, Judge Acronyms, Ring Types
  - All placement rows, preserving the table structure and voiding rules
  - Each cell is formatted as `CAT number - status - V` if voided, or `CAT number - status` if not voided, or `-` if empty
- **If a Cat # input is VOID (case-insensitive, trimmed), the status dropdown/label is hidden in the UI and only 'VOID' (uppercase, no spaces) is saved/restored in the CSV for that cell. This applies to all tabs, including Kitten and Household Pet.**
- **All data is exported in a way that matches the documented JSON schema and is fully restoreable**

### Example (Section Separation)

```

General Information
Show Name,Example Cat Show
Show Date,2024-07-01
...
Judges
Judge Name,Acronym,Ring Type
John Smith,JSM,Allbreed
...

Championship Awards
,Ring 1,Ring 2
,JSM,ABC
,Allbreed,Longhair
1st Place,123-GC,456-GC
2nd Place,124-CH,457-CH
...

Premiership Awards
,Ring 1,Ring 2
,JSM,ABC
,Allbreed,Longhair
1st Place,223-GP,256-GP
...

Kitten Awards
,Ring 1,Ring 2
,JSM,ABC
,Allbreed,Longhair
1st Place,323-KIT,356-KIT
...

Household Pet Awards
,Ring 1,Ring 2
,JSM,ABC
,Allbreed,Longhair
1st Place,423-HHP,456-HHP
...
```

### Restoreability
- This format guarantees that **all tabular data, placements, voiding, and section separation can be restored** exactly as entered, per the [CSV_EXPORT_SCHEMA.json](specs/CSV_EXPORT_SCHEMA.json).
- See the schema for the authoritative structure.

---

## 11. Field Escaping and Special Characters

All fields in the CSV are escaped according to the CSV standard to ensure that commas, quotes, and newlines inside field values do not break the file structure:

- **If a field contains a comma, double quote, or newline:**
  - The entire field is enclosed in double quotes (`"...")
  - Any double quotes inside the field are escaped by doubling them (e.g., `"` becomes `""`)

### Examples
- Field with a comma: `John, Williams` → `"John, Williams"`
- Field with a quote: `John "The Cat" Williams` → `"John ""The Cat"" Williams"`
- Field with a newline: `123 Main St\nApt 4` → `"123 Main St
Apt 4"`

**This escaping is applied to all fields, including show names, judge names, addresses, and placement/status cells.**

When restoring from CSV, the parser must reverse this escaping: recognize quoted fields, unescape doubled quotes, and treat embedded commas/newlines as part of the field value.

---

### CSV Export/Import

All tabular data (Championship, Premiership, Kitten, Household Pet) is exported in sectioned format, with all placements, voiding, and headers preserved. The export is always complete, regardless of which tab triggers the export. General tab data is output as key-value pairs, and judge information is included as a table. All fields are properly escaped for CSV (commas, quotes, newlines).

**Household Pet Tab Data**
- Household Pet tab placements and voiding are now fully included in the CSV export and import, matching the structure and restoreability of other tabs.
- The HouseholdPetTab component now receives its data and setter as props (`householdPetTabData`, `setHouseholdPetTabData`), ensuring all changes are reflected in the exported CSV.
- All placements, voiding, and awards for Household Pet are exported and restoreable.

**Breed Sheets Tab Data**
- Breed Sheets tab data is fully included in the CSV export and import, with separate storage for each judge-group-hair length combination.
- The BreedSheetsTab component receives its data and setter as props (`breedSheetsTabData`, `setBreedSheetsTabData`), ensuring all changes are reflected in the exported CSV.
- All BoB, 2BoB, Best CH, and Best PR awards are exported and restoreable.
- Breed list management is integrated with the Settings panel, with dynamic updates when breeds are added/removed.
- Search functionality allows real-time filtering of breed names for improved usability.

**Note:** All tab data is now lifted to the top-level App state for consistency and reliability in export/import. 

#### Key Format for Placements and Voids
All placement and voided keys use hyphens (e.g., '0-0') for column-row addressing. This is required for CSV export compatibility. Do not use underscores.

#### Household Pet Section
The Household Pet section is always included in the CSV export, even if empty. This ensures schema consistency and restoreability.

#### Export Completeness
The CSV export always includes all tabs and sections, regardless of which tab triggers the export or whether any section is empty. 

#### Finals Row Labels
Finals rows in the Championship and Premiership sections now use user-facing labels:
- Championship: 'Best AB CH', '2nd Best AB CH', ..., 'Best LH CH', ..., 'Best SH CH', ...
- Premiership: 'Best AB PR', '2nd Best AB PR', ..., 'Best LH PR', ..., 'Best SH PR', ...
These labels appear in the exported CSV and match the UI, ensuring clarity and restoreability.

#### Finals Row Mapping Fix
The CSV export now correctly writes all 'Best AB CH', 'Best LH CH', and 'Best SH CH' rows (and their ordinal variants) for each judge/column in the Championship section. The export logic maps each finals row to the correct key in the state (e.g., 'championsFinals', 'lhChampionsFinals', 'shChampionsFinals') and writes the cat number for each judge/column. This ensures all finals data is present in the CSV and matches the UI.

#### Defensive Extraction for Placements/Finals
The CSV export now robustly extracts all placement and finals data, regardless of whether the data is stored as a string or object. Each cell is written to the CSV using a defensive extractCell function, ensuring no blanks due to type mismatches. This guarantees all user input is exported.

#### Developer Note
The extractCell logic in csvExport.ts handles string, object, or undefined cell values, preventing blank or missing data in the CSV export.

#### Developer Note
The mapping logic uses the finals row index modulo 5 to select the correct key for each section, ensuring the correct cat number is written for each position and judge. 

## CSV Export Error Handling

### CSV Export File Save Dialog

When you click the 'Save to CSV' button and validation passes (no errors), the application will:

- **Modern Browsers**: Open a file save dialog allowing you to choose where to save the CSV file. The filename will be auto-generated in the format `YYYYMMDD_HHMMSS_showName.csv` but you can change the location and filename if desired.

- **Older Browsers**: Automatically download the file to your default downloads folder with the auto-generated filename.

The auto-generated filename format is: `YYYYMMDD_HHMMSS_showName.csv`
- Example: `20241215_143022_ExampleCatShow.csv`

### General Tab: Save to CSV Error Handling

- If you click the 'Save to CSV' button while there are validation errors on the General tab, a modal dialog will appear with the message:
  > CSV cannot be generated until all errors on this tab have been resolved. Please fix all highlighted errors before saving.
- You must resolve all highlighted errors before you can export the CSV.
- The previous error toast for this scenario has been replaced by this modal for improved clarity.

### Championship Tab: Save to CSV Error Handling

- If you click the 'Save to CSV' button while there are validation errors on the Championship tab, a modal dialog will appear with the message:
  > CSV cannot be generated until all errors on this tab have been resolved. Please fix all highlighted errors before saving.
- You must resolve all highlighted errors before you can export the CSV.
- The previous error toast for this scenario has been replaced by this modal for improved clarity.

### Premiership Tab: Save to CSV Error Handling

- If you click the 'Save to CSV' button while there are validation errors on the Premiership tab, a modal dialog will appear with the message:
  > CSV cannot be generated until all errors on this tab have been resolved. Please fix all highlighted errors before saving.
- You must resolve all highlighted errors before you can export the CSV.
- The previous error toast for this scenario has been replaced by this modal for improved clarity.

### Kitten Tab: Save to CSV Error Handling

- If you click the 'Save to CSV' button while there are validation errors on the Kitten tab, a modal dialog will appear with the message:
  > CSV cannot be generated until all errors on this tab have been resolved. Please fix all highlighted errors before saving.
- You must resolve all highlighted errors before you can export the CSV.
- The previous error toast for this scenario has been replaced by this modal for improved clarity.

### Household Pet Tab: Save to CSV Error Handling

- If you click the 'Save to CSV' button while there are validation errors on the Household Pet tab, a modal dialog will appear with the message:
  > CSV cannot be generated until all errors on this tab have been resolved. Please fix all highlighted errors before saving.
- You must resolve all highlighted errors before you can export the CSV.
- The previous error toast for this scenario has been replaced by this modal for improved clarity. 

## Status Dropdown Design System (2024-06)

All status dropdowns in the Championship, Premiership, Kitten, and Household Pet tabs now use a uniform, modern design system:

- **If a Cat # input is VOID, the status dropdown/label is hidden (not rendered) for that cell.**
- **Main Box:** Always white (`bg-white`), no theme background fill.
- **Border:** Subtle, rounded, and in the tab's theme color (violet, blue, green, orange).
- **Font:** Modern, readable (`Inter, Montserrat, Arial, Helvetica Neue, sans-serif`), 15px, medium weight.
- **Size:** Consistent pill shape (`h-9`, `min-w-[70px]`, `rounded-full`, `px-3 py-1.5`).
- **Focus:** Border thickens and theme color intensifies slightly, no glow or background fill.
- **Dropdown Menu:** Options use a very light theme background on hover/selected, but the main box remains white.
- **Static Labels:** Kitten and HHP tabs use a styled span matching the dropdown's font, size, border, and color.

**Rationale:**
- Ensures perfect visual and UX parity across all tabs.
- Modern SaaS look: clean, accessible, and easy to scan.
- Theme color is only used for border and dropdown menu highlights, never for the main background or text.

**Implementation:**
- See `CustomSelect.tsx` for the implementation and theme props.
- All usages in the four tabs have been updated for parity. 

## Table Column Focus Highlight (2024-06)

All four tab tables (Championship, Premiership, Kitten, Household Pet) now use a perfectly uniform, modern column focus highlight:

- **Focused Column:** Only a thickened border (`border-l-4 border-r-4`) in the tab's theme color (violet, blue, green, orange) is used to indicate focus. No background color is applied to the focused column.
- **Hover:** Table row hover backgrounds remain as designed per tab, but do not affect the focused column highlight.
- **Rationale:** This ensures a clean, modern SaaS look and perfect visual parity across all tabs, with no distracting background color for focused columns. 

### Table Column Width Parity (2024-06)

- The Household Pet tab now uses the exact same column widths as the Kitten tab for perfect visual parity:
  - Judge columns: **170px** wide (header and all data cells)
  - Placement cells: **110px** wide if a cat number is present, **90px** if empty
- This ensures all four tabs (Championship, Premiership, Kitten, HHP) have a consistent, modern SaaS table layout.
- No other logic or style was changed.

### Household Pet Tab VOID Placement Logic (2024-06)

- **VOID Entry:** To mark a placement as VOID, simply type 'v' or 'V' in the Cat # input; it will auto-complete to 'VOID'.
- **Visual:** VOID rows are visually struck through and grayed out for clarity, but remain editable (no disabling).
- **Validation:** VOID placements are ignored by all validation rules (range, sequential, duplicate, status) and are treated as if they do not exist.
- **No Checkbox:** The void checkbox has been removed for simplicity and parity with the Kitten tab.
- **Parity:** This logic is now identical to the Kitten tab's VOID handling, ensuring a consistent user experience.
- **Rationale:** This change streamlines the UI, reduces confusion, and ensures that VOID logic is robust, predictable, and easy to use across both tabs. 

### Household Pet Tab Reset & Autofocus (2024-06)

- The Household Pet tab reset is now instant and robust: when the reset button is confirmed, all visible cells (columns × rows) are immediately re-initialized, and the table is ready for input with no delay.
- On tab activation, the first Cat # input (row 0, column 0) is auto-focused for fast data entry, matching the behavior of the Kitten and Championship tabs.
- This ensures perfect parity and a modern, efficient user experience across all tabs. 

- All numeric fields imported from CSV (e.g., counts, judge numbers, etc.) are now robustly defaulted to 0 if missing or invalid. This prevents React controlled/uncontrolled input warnings and ensures a smooth user experience.
- All number inputs in the UI are always controlled (never undefined or NaN). If a value is missing or invalid, the input will show as empty until a valid number is entered. 

- The Championship tab now uses dynamic validation for Cat # fields in all sections (Top 10/15, Best AB CH, Best LH CH, Best SH CH) that matches the Premiership tab. Cat # validation is only triggered on blur/tab/enter, not on every keystroke. Error order and logic are fully consistent with the Premiership tab. No validation rules or user-facing workflows changed; this is a timing and UX parity update. 
- In the Championship tab, you can now type 'v' or 'V' in any Cat # input (showAwards section) and it will auto-complete to 'VOID', matching the Kitten and HHP tabs. 