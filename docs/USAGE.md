
# CSV Export & Restore Format

This section documents the precise format of the CSV file generated by the CFA Master Clerk Entry Tool, and how it can be used to restore the full show state. This is the authoritative reference for both export and import/restore logic.

---

## CSV Export & Restore Format (Updated)

### Section Separation
- **A blank row is inserted before the beginning of each new section** (including before General Information, Championship, Premiership, Kitten, Household Pet).
- Each section starts with a section label row in the first column (e.g., "General Information", "Championship Awards").

### Tabular Sections (Championship, Premiership, Kitten, Household Pet)
- Each tabular section is exported as a table:
  - Three header rows: Ring Numbers, Judge Acronyms, Ring Types
  - All placement rows, preserving the table structure and voiding rules
  - Each cell is formatted as `CAT number - status - V` if voided, or `CAT number - status` if not voided, or `-` if empty
- **All data is exported in a way that matches the documented JSON schema and is fully restoreable**

### Example (Section Separation)

```

General Information
Show Name,Example Cat Show
Show Date,2024-07-01
...
Judges
Judge Name,Acronym,Ring Type
John Smith,JSM,Allbreed
...

Championship Awards
,Ring 1,Ring 2
,JSM,ABC
,Allbreed,Longhair
1st Place,123-GC,456-GC
2nd Place,124-CH,457-CH
...

Premiership Awards
,Ring 1,Ring 2
,JSM,ABC
,Allbreed,Longhair
1st Place,223-GP,256-GP
...

Kitten Awards
,Ring 1,Ring 2
,JSM,ABC
,Allbreed,Longhair
1st Place,323-KIT,356-KIT
...

Household Pet Awards
,Ring 1,Ring 2
,JSM,ABC
,Allbreed,Longhair
1st Place,423-HHP,456-HHP
...
```

### Restoreability
- This format guarantees that **all tabular data, placements, voiding, and section separation can be restored** exactly as entered, per the [CSV_EXPORT_SCHEMA.json](specs/CSV_EXPORT_SCHEMA.json).
- See the schema for the authoritative structure.

---

## 11. Field Escaping and Special Characters

All fields in the CSV are escaped according to the CSV standard to ensure that commas, quotes, and newlines inside field values do not break the file structure:

- **If a field contains a comma, double quote, or newline:**
  - The entire field is enclosed in double quotes (`"...")
  - Any double quotes inside the field are escaped by doubling them (e.g., `"` becomes `""`)

### Examples
- Field with a comma: `John, Williams` → `"John, Williams"`
- Field with a quote: `John "The Cat" Williams` → `"John ""The Cat"" Williams"`
- Field with a newline: `123 Main St\nApt 4` → `"123 Main St
Apt 4"`

**This escaping is applied to all fields, including show names, judge names, addresses, and placement/status cells.**

When restoring from CSV, the parser must reverse this escaping: recognize quoted fields, unescape doubled quotes, and treat embedded commas/newlines as part of the field value.

---

### CSV Export/Import

All tabular data (Championship, Premiership, Kitten, Household Pet) is exported in sectioned format, with all placements, voiding, and headers preserved. The export is always complete, regardless of which tab triggers the export. General tab data is output as key-value pairs, and judge information is included as a table. All fields are properly escaped for CSV (commas, quotes, newlines).

**Household Pet Tab Data**
- Household Pet tab placements and voiding are now fully included in the CSV export and import, matching the structure and restoreability of other tabs.
- The HouseholdPetTab component now receives its data and setter as props (`householdPetTabData`, `setHouseholdPetTabData`), ensuring all changes are reflected in the exported CSV.
- All placements, voiding, and awards for Household Pet are exported and restoreable.

**Note:** All tab data is now lifted to the top-level App state for consistency and reliability in export/import. 

#### Key Format for Placements and Voids
All placement and voided keys use hyphens (e.g., '0-0') for column-row addressing. This is required for CSV export compatibility. Do not use underscores.

#### Household Pet Section
The Household Pet section is always included in the CSV export, even if empty. This ensures schema consistency and restoreability.

#### Export Completeness
The CSV export always includes all tabs and sections, regardless of which tab triggers the export or whether any section is empty. 

#### Finals Row Labels
Finals rows in the Championship and Premiership sections now use user-facing labels:
- Championship: 'Best AB CH', '2nd Best AB CH', ..., 'Best LH CH', ..., 'Best SH CH', ...
- Premiership: 'Best AB PR', '2nd Best AB PR', ..., 'Best LH PR', ..., 'Best SH PR', ...
These labels appear in the exported CSV and match the UI, ensuring clarity and restoreability.

#### Finals Row Mapping Fix
The CSV export now correctly writes all 'Best AB CH', 'Best LH CH', and 'Best SH CH' rows (and their ordinal variants) for each judge/column in the Championship section. The export logic maps each finals row to the correct key in the state (e.g., 'championsFinals', 'lhChampionsFinals', 'shChampionsFinals') and writes the cat number for each judge/column. This ensures all finals data is present in the CSV and matches the UI.

#### Defensive Extraction for Placements/Finals
The CSV export now robustly extracts all placement and finals data, regardless of whether the data is stored as a string or object. Each cell is written to the CSV using a defensive extractCell function, ensuring no blanks due to type mismatches. This guarantees all user input is exported.

#### Developer Note
The extractCell logic in csvExport.ts handles string, object, or undefined cell values, preventing blank or missing data in the CSV export.

#### Developer Note
The mapping logic uses the finals row index modulo 5 to select the correct key for each section, ensuring the correct cat number is written for each position and judge. 

## CSV Export Error Handling

### CSV Export File Save Dialog

When you click the 'Save to CSV' button and validation passes (no errors), the application will:

- **Modern Browsers**: Open a file save dialog allowing you to choose where to save the CSV file. The filename will be auto-generated in the format `YYYYMMDD_HHMMSS_showName.csv` but you can change the location and filename if desired.

- **Older Browsers**: Automatically download the file to your default downloads folder with the auto-generated filename.

The auto-generated filename format is: `YYYYMMDD_HHMMSS_showName.csv`
- Example: `20241215_143022_ExampleCatShow.csv`

### General Tab: Save to CSV Error Handling

- If you click the 'Save to CSV' button while there are validation errors on the General tab, a modal dialog will appear with the message:
  > CSV cannot be generated until all errors on this tab have been resolved. Please fix all highlighted errors before saving.
- You must resolve all highlighted errors before you can export the CSV.
- The previous error toast for this scenario has been replaced by this modal for improved clarity.

### Championship Tab: Save to CSV Error Handling

- If you click the 'Save to CSV' button while there are validation errors on the Championship tab, a modal dialog will appear with the message:
  > CSV cannot be generated until all errors on this tab have been resolved. Please fix all highlighted errors before saving.
- You must resolve all highlighted errors before you can export the CSV.
- The previous error toast for this scenario has been replaced by this modal for improved clarity.

### Premiership Tab: Save to CSV Error Handling

- If you click the 'Save to CSV' button while there are validation errors on the Premiership tab, a modal dialog will appear with the message:
  > CSV cannot be generated until all errors on this tab have been resolved. Please fix all highlighted errors before saving.
- You must resolve all highlighted errors before you can export the CSV.
- The previous error toast for this scenario has been replaced by this modal for improved clarity.

### Kitten Tab: Save to CSV Error Handling

- If you click the 'Save to CSV' button while there are validation errors on the Kitten tab, a modal dialog will appear with the message:
  > CSV cannot be generated until all errors on this tab have been resolved. Please fix all highlighted errors before saving.
- You must resolve all highlighted errors before you can export the CSV.
- The previous error toast for this scenario has been replaced by this modal for improved clarity.

### Household Pet Tab: Save to CSV Error Handling

- If you click the 'Save to CSV' button while there are validation errors on the Household Pet tab, a modal dialog will appear with the message:
  > CSV cannot be generated until all errors on this tab have been resolved. Please fix all highlighted errors before saving.
- You must resolve all highlighted errors before you can export the CSV.
- The previous error toast for this scenario has been replaced by this modal for improved clarity. 